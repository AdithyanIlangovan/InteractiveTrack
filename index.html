<!DOCTYPE html> 
  
<html lang="en"> 

<head> 
   <meta charset="utf-8"> 
   <title>Custom HTML5 Video Player</title> 
   <link rel="stylesheet" type="text/css" href="style.css">
</head> 

<body onload = "startTimer()">  
<div id="container">  
    <h1 align="center"> Demonstration for web interactive track </h1>   
    <div id="video_container"> 

	<video id="video" controls autoplay width="1280" height="720"> 
            <source src="http://10.4.247.130/InteractiveTrack/ToS.mp4" type="video/mp4">              
        </video> 
		<!-- Left image thumbnail with rotating actors image and actors info from imdb link  -->
		<div id="image_container_1" class="imgWrapper"> 
		   <img id="img" src="" width="100%" align="middle"/>
		   <figcaption>
		   <a id = "links" href=""> <p id="links_text"> </p> </a>
		  <!--<p> Playback position: <font color="white"> <span style="font-color: white;" id="demo" > </span> </font> </p>-->
		   </figcaption>
		</div>    

		<!-- Show you maybe also interested in text  -->
		<div id="text_end" class="imgWrapper"> 
		   <p align="middle"> <font color="white"> <span id="video_end_text"  align="middle"> </span> </font> </p>
		</div>

		<!-- Interesting video 1, top right with youtube link  -->
		<div id="image_container_2" class="imgWrapper"> 
		   <img id="img_2" width="400px"/>
		   <p align="middle"> <a id = "links_2" > <span style="font-color: white;" id="link_1_end" > </span> </a></p>
		</div>

		<!-- Interesting video 2, bottom right with youtube link  -->
		<div id="image_container_3" class="imgWrapper"> 
		   <img id="img_3" width="400pxhttps://erasmusu.com/de/erasmus-klagenfurt/studentenwohnung-zu-vermieten/sunny-single-apartment-in-klagenfurt-city-for-renting-463050" />
		   <p align="middle"> <a id = "links_3" > <span style="font-color: white;" id="link_2_end" > </span> </a></p>
		</div>
    </div>    

</div>       
</body> 

<script type = "text/javascript">

	var vid = document.getElementById("video"); // Get the <video> element with id="myVideo"
	// x is the state tracker, it change s
	var leftthumbnail_period = 5; // The period of update for the images in the left thumbnail.
	var x = -1, x_curr = 9; // Ideally you want these things to be local variable. 
					    // We are setting them to be global implementation, since
					    // We want a simpler implementation.
	var currentPlaybackTime;    	    // Store the current playback time obtained from the video element.
	var justBeforeVideo = 0;		    // The state variable that indicates the whether we have crossed the (video_end - 5 seconds) boundary.
	
	var video_end_boundary = 0;	    // The state variable that indicates the whether we have crossed the (video_end - 5 seconds) boundary.
	var video_end_boundary_prev = 0;    // The state variable that indicates the whether we have crossed the (video_end - 5 seconds) boundary.
	
	var image_start 	  = [2.0,  6, 15.25, 22, 32];
	var image_end	  = [4.5, 10, 18.50, 25, 34];

	var new_image_available = 0;	   // State machine to update that keeps track when we move into the boundaries defined earlier
	var prev_state = 0;
	
	function displayNextImage() {
	  // Display the image and also the url for the image.
	  // The url for the image is read from the localstorage with the key "link_for_image"

	  var link_for_image = localStorage.getItem('link_for_image');
	  var link_for_imagelinks = localStorage.getItem('link_for_imagelinks');

	  console.log('Reading from local storage and setting the url for current image');
	  
	  if (link_for_image == "null"){  
	    document.getElementById("img").src = "";
	    document.getElementById("links").href = "";  
	    document.getElementById("links_text").innerHTML = "";  
	  }
	 else{
	    document.getElementById("img").src = link_for_image;
	    document.getElementById("links").href = link_for_imagelinks;
	    document.getElementById("links_text").innerHTML = "Know more about me";  
	 }
	}
	
	function checkForImageUpdateTrigger(){
	    if (new_image_available){
		displayNextImage(); // If new image is available just display what is present in the local storage
		new_image_available = 0;
	    }
	}

	function emulateReceiveAndStoreInLocalStorage(){

	  //currentPlaybackTime = Math.round(vid.currentTime * 100)/100;

	  //document.getElementById("demo").innerHTML = Math.round(vid.currentTime);
	  var state = identifyCurrentPosition(vid.currentTime);  
	  x = Math.floor(currentPlaybackTime / leftthumbnail_period) % 3; 

	  if (state != prev_state) { 
	  // change the source images if only these is  a
	  // change in the state when compared to the previous.
	  // at the same time trigger, two things happen simulatenously:
	  // 1. Read value from the interactive track and store them in the local storage.
	  // 2. Read value from the local storage and do things apporiately. Happens at display next image function.
		console.log("Current state " + state);	
		readFromInteractiveTrackAndStoreURL(state);
		new_image_available = 1;
		prev_state = state;
		//displayNextImage();
		//x_curr = x;
	    }	  	
	}
	

	Number.prototype.between = function (min, max) {
	  return this > min && this < max;
	};
	
	
	function identifyCurrentPosition(x){
	  var loc = 0;
	  for (var i = 0; i < image_start.length; i++){
	    if (x.between(image_start[i], image_end[i])){
	      loc = i+1;
	    }
	  }
	  return loc;
	}
	
	function startTimer() {	 
	   // Use this in case we want to set out periodic fine-grained monitoring the playback time. 
	   // The problem with using internal media controller firing engine, onTimeUpdate() function is that
	   // the timing granularity cannot be controlled. The granularity can vary anywhere from 20ms-250ms. 
	   // It is good if we do not have problems with less than 250ms granularties.
	  setInterval(checkForImageUpdateTrigger, 100);
	}

	function readFromInteractiveTrackAndStoreURL(pos) {	 
	  // Emulates periodic reading of interactive track of URL information. 
	  // We assume this information is somehow read from the interactive track.
	  // And this information is stored in local storage for later processing by some other element.
	  var images = []
	  var links  = [];
	  
	  console.log("Reading from interactive track and storing the URL in local storage. Current position" + x);
	  
	  images[0] = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/actor1.jpg";           
	  images[1] = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/actor2.jpg";	    
	  images[2] = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/actor2.jpg";
	  images[3] = "http://www.tgmax.nl/upload/images/algemeen/acteurs/Rogier%20Schippers%20Maas%20theater%20en%20dans%20%AEPhile%20Deprez.jpg";
	  images[4] = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/actor3.jpg";
	  
	  links[0]  = "http://www.imdb.com/name/nm4495815/?ref_=ttfc_fc_cl_t4";
	  links[1]  = "http://www.imdb.com/name/nm3316142/?ref_=ttfc_fc_cl_t2";
	  links[2]  = "http://www.imdb.com/name/nm3316142/?ref_=ttfc_fc_cl_t2";
	  links[3]  = "http://www.imdb.com/name/nm1851201/?ref_=tt_cl_t3";
	  links[4]  = "http://www.imdb.com/name/nm0513190/?ref_=ttfc_fc_cl_t1";
	  
	  
	  if (!pos){	     
	    localStorage.setItem('link_for_image', "null"); // I do not want to display anything.
	    localStorage.setItem('link_for_imagelinks', "null"); // I do not want to display anything.
	  }
	  else {
	    console.log(images[pos]);
	    console.log(links[pos]);
	    localStorage.setItem('link_for_image', images[pos-1]);
	    localStorage.setItem('link_for_imagelinks', links[pos-1]);
	  }
	}

	function readFromInteractiveTrackAndStoreFunction() {	 
	  // Emulates periodic reading of interactive track of javascript function information.
	  // We assume this information is somehow read from the interactive track.
	  // And this information is stored in local storage for later processing by some other element.
	    
	  // We create a sample javascript file. Store into blob. Get a URL to this blob. Read the content from blob.
	  // And append this content to the headelement in runtime.
	    
	    var head = document.getElementsByTagName('head')[0];
	    var script = document.createElement('script');
	    script.type = 'text/javascript';  	          
	    var string =  'function beforeVideoEnds() {' +
				    'console.log("Calling before video ends function");' +
				    'document.getElementById("video_end_text").innerHTML = "You may be also interested in" ;' + 
				    'document.getElementById("img_2").src = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/sintel.jpg";' + 
				    'document.getElementById("links_2").href = "https://www.youtube.com/watch?v=eRsGyueVLvQ";' +  
				    'document.getElementById("link_1_end").innerHTML = "Watch here" ;' +
				    'document.getElementById("img_3").src = "https://raw.githubusercontent.com/AdithyanIlangovan/InteractivityTrackImages/master/bbb.png";' +
				    'document.getElementById("links_3").href = "https://www.youtube.com/watch?v=YE7VzlLtp-4";' +
				    'document.getElementById("link_2_end").innerHTML = "Watch here" ;}'; 
	    var myBlob = new Blob([string], {type : "text/javascript"});
	    var blobUrl = window.URL.createObjectURL(myBlob)
	    console.log(blobUrl);
	    console.log(myBlob.type);    
	    
	    script.src = blobUrl;
	    //script.src = 'videoEnds.js'; // In case you want to directly point to the file.     
	    head.appendChild(script);
      }

	function removeVideoSuggestionThumbnails(){

	document.getElementById("video_end_text").innerHTML = "" ;
	document.getElementById("img_2").src = "";
	document.getElementById("links_2").href = "";	  
	document.getElementById("link_1_end").innerHTML = "" ;

	document.getElementById("img_3").src = "";
	document.getElementById("links_3").href = "";	  
	document.getElementById("link_2_end").innerHTML = "" ;
      }
            
	function myFunction() {	
	  // This function will be executed everytime there is a change in playback position.
	  // Then we check with statemachine (a very simple one!) to check whether we have crossed the boundaries. 
	  // If yes, call the apporiate functions and set the apporiate elements within the style sheet.  
	  

	  video_end_boundary = (vid.duration - vid.currentTime) < 5 ? 1 : 0;
	  
	  if (video_end_boundary != video_end_boundary_prev){ // state machine to keep track whether it crossed the boundary
		  
		  if (video_end_boundary){
		    console.log("Crossed the video suggestion boundary. Show thumbnails.");
		    readFromInteractiveTrackAndStoreFunction();
		    // Ideally add some delay between these two statements. 
		    // Or call the next function only after the javascript has been loaded.
		    beforeVideoEnds();
		  }
		  else 
		  {
		    console.log("Crossed the video suggestion boundary. Remove thumbnails.");
		    removeVideoSuggestionThumbnails();
		  }
		    
		  video_end_boundary_prev = video_end_boundary; 
	  }	
	}
	
	/*
	//Adi delete later when you don't need it!
	var handle_storage = function () {
	      alert('storage event');
	      console.log("hey");
	      var name = localStorage.getItem('name');
	      console.log(name);
	};

	window.addEventListener("storage", handle_storage, false);	
	*/
	vid.ontimeupdate = function() {myFunction(); emulateReceiveAndStoreInLocalStorage();}; 
	// Use this if you want the internal media controller firing engine reponse to trigger, when you want to call the function.
</script>

</html>
